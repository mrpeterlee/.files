#!/usr/bin/env bash
set -euo pipefail

{{ if .hasOp -}}
echo "==> 1Password CLI already installed"
{{ else -}}
# Check if we can use sudo (non-interactive mode without passwordless sudo will skip)
CAN_SUDO=false
if sudo -n true 2>/dev/null; then
    CAN_SUDO=true
elif [[ -t 0 ]]; then
    # Interactive mode - sudo will prompt for password
    CAN_SUDO=true
fi

if [[ "$CAN_SUDO" != "true" ]]; then
    echo "==> Skipping 1Password CLI installation (sudo not available in non-interactive mode)"
    echo "==> Run './cli prereq' interactively to install 1Password CLI"
    exit 0
fi

echo "==> Installing 1Password CLI..."

{{ if eq .pkgmgr "apt" -}}
# Add 1Password apt repository
curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
    sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg 2>/dev/null || true

echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
    sudo tee /etc/apt/sources.list.d/1password.list

sudo mkdir -p /etc/debsig/policies/AC2D62742012EA22/
curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol | \
    sudo tee /etc/debsig/policies/AC2D62742012EA22/1password.pol
sudo mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22
curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
    sudo gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg 2>/dev/null || true

sudo apt update && sudo apt install -y 1password-cli

{{ else if eq .pkgmgr "brew" -}}
brew install --cask 1password-cli

{{ else if eq .pkgmgr "pacman" -}}
# 1Password CLI via AUR - requires yay or paru
if command -v yay &>/dev/null; then
    yay -S --noconfirm 1password-cli
elif command -v paru &>/dev/null; then
    paru -S --noconfirm 1password-cli
else
    echo "Warning: Please install 1password-cli from AUR manually (yay -S 1password-cli)"
fi

{{ else if eq .pkgmgr "dnf" -}}
sudo rpm --import https://downloads.1password.com/linux/keys/1password.asc
sudo sh -c 'echo -e "[1password]\nname=1Password Stable Channel\nbaseurl=https://downloads.1password.com/linux/rpm/stable/\$basearch\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://downloads.1password.com/linux/keys/1password.asc" > /etc/yum.repos.d/1password.repo'
sudo dnf install -y 1password-cli

{{ end -}}
{{ end -}}

echo "==> 1Password CLI setup complete"
