# Windows Neovim setup
# Creates symlink and syncs plugins

$ErrorActionPreference = "Stop"

Write-Host "==> Setting up Neovim (Windows)..."

$nvimConfigTarget = Join-Path $env:USERPROFILE ".config\nvim"
$nvimConfigLink = Join-Path $env:LOCALAPPDATA "nvim"
$nvimDataDir = Join-Path $env:LOCALAPPDATA "nvim-data"

# Create nvim data directories
foreach ($sub in @("", "shada", "swap", "undo", "backup")) {
    $dir = Join-Path $nvimDataDir $sub
    if (-not (Test-Path $dir)) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
        Write-Host "    Created $dir"
    }
}

# Create symlink: %LOCALAPPDATA%\nvim -> ~/.config/nvim
if (Test-Path $nvimConfigTarget) {
    if (Test-Path $nvimConfigLink) {
        $item = Get-Item $nvimConfigLink -Force
        if ($item.LinkType -in @("SymbolicLink", "Junction")) {
            Write-Host "    [ok] nvim config link already exists"
        } else {
            Write-Warning "    $nvimConfigLink exists but is not a symlink — skipping"
        }
    } else {
        # Try symlink first (requires admin or Developer Mode), fall back to junction
        try {
            New-Item -ItemType SymbolicLink -Path $nvimConfigLink -Target $nvimConfigTarget -Force | Out-Null
            Write-Host "    Linked $nvimConfigLink -> $nvimConfigTarget"
        } catch {
            try {
                New-Item -ItemType Junction -Path $nvimConfigLink -Target $nvimConfigTarget | Out-Null
                Write-Host "    Linked $nvimConfigLink -> $nvimConfigTarget (junction)"
            } catch {
                Write-Warning "    Could not create nvim config link (run as admin or enable Developer Mode)"
            }
        }
    }
} else {
    Write-Warning "    nvim config source not found: $nvimConfigTarget"
}

# Sync Lazy.nvim plugins (headless)
$nvim = Get-Command nvim -ErrorAction SilentlyContinue
if ($nvim) {
    Write-Host "==> Syncing Lazy.nvim plugins..."
    & nvim --headless "+Lazy! sync" +qa 2>$null

    Write-Host "==> Updating Mason packages..."
    & nvim --headless "+MasonUpdate" +qa 2>$null
} else {
    Write-Warning "    nvim not found in PATH — skipping plugin sync"
}

Write-Host "==> Neovim setup complete"
